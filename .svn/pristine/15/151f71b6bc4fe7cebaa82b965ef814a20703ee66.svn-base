/*
*插件通用类
*/

function PluginContent(){
	var _this = this;
	this.exchange_rate = 6.1345;//人名币与美元兑换汇率
	this.site_id = 0;//来源网站id
	this.site_name = '';//来源网站名称
	this.prodQty = 1;//商品数量
	this.prodWeight = 0;//商品重量(磅)
	this.weight_loaded = false;//商品重量是否已经加载
	this.goodsPrice = 0;//商品单价
	this.price_loaded = false;//商品单价是否已经加载
	this.tax_type = 0;//关税类型
	this.dutiable_value = 0;//完税价格
	this.tax_rate = 0;//关税税率
	this.actual_tariff = 0;//实报关税
	this.default_tariff = 0;//默认关税
	this.tax_price = 0;//关税价格
	this.totleFee = 0;//总运费
	this.totlePrice = 0;//总价
	this.user_id = 0;//用户id
	this.user_mobile = '';//用户手机号码
	this.animating = false;//动画是否进行的标记
	this.cart_page = 1;//默认显示第一页
	this.direct_mail_china = false;//是否支持直邮中国
	
	//获取自身对象
	this.get_this = function(){return _this;}
	
	//插件初始化
	this.init = function(){
		//加载插件css文件
		var css_obj = $('<link rel="stylesheet" type="text/css" href="'+PluginConf.css_file+'" />');
		css_obj.bind('load',function(){
			//载入页面
			kango.invokeAsync('kango.storage.getItem', 'plugin_switch', function(data){
				if(data!='off'){
					//获取用户id
					kango.invokeAsync('kango.storage.getItem', 'user_id', function(user_id) {
						_this.user_id = user_id;
						//获取美元汇率
						kango.invokeAsync('kango.storage.getItem', 'exchange_rate', function(exchange_rate){
							if(data!=0){
								_this.exchange_rate = exchange_rate;
							}
							//页面初始化
							_this.content_init();
							
							//获取用户登录状态
							_this.get_user_login();
							
							//加载产品分类
							_this.load_product_cat();
							
							//刷新直邮中国标记
							_this.refresh_china_tag();
							
							//加载用户运单列表
							_this.refresh_cart_list();
							
							//刷新内容
							_this.refresh_content();
							
							//绑定事件
							_this.bind_event();
							
							//记录用户浏览记录
							_this.record_view_history();
						});
					});
				}
			});
			//划词翻译
			kango.invokeAsync('kango.storage.getItem', 'translate_switch', function(data){
				if(data!='off'){
					_this.enable_translate();
				}
			});
		}).appendTo($('head'));
	}
	
	this.append_plugin = function(){
		if(_this.get_name()){
			var plugin_container_html = '<div id="'+PluginConf.css_refix+'plugin_container">'+
											'<div id="'+PluginConf.css_refix+'plugin_position">'+
												'<img id="'+PluginConf.css_refix+'plugin_tag" src="'+PluginConf.img_path+'open.png"/>'+
												PluginDiv+
											'</div>'+
										'</div>';
			var plugin_container = $(plugin_container_html);
			plugin_container.find('#'+PluginConf.css_refix+'plugin_main').css({'position':'absolute','right':'38px','top':'26px','width':'520px','display':'none'});
			plugin_container.hover(function(){
				$(this).find('#'+PluginConf.css_refix+'plugin_main').show();
			},function(){
				$(this).find('#'+PluginConf.css_refix+'plugin_main').hide();
			});
			plugin_container.appendTo($('body'));
		}
	}
	
	//开启划词翻译
	this.enable_translate = function(){
		$(document).mouseup(function(e){
			var translation_timer;
			//获取鼠标位置
			var mouse_x = e.pageX;
			var mouse_y = e.pageY;
			var mouse_type = e.which;//1:鼠标左键，2：鼠标中键，3：鼠标右键
			if(mouse_type==1){
				//翻译结果主元素
				var translation_main = $('#'+PluginConf.css_refix+'translation_main');
				//获取选取的文字内容(延迟加载，防止点击已选择的文字再次触发)
				setTimeout(function(){
					var select_text = $.trim(_this.get_select_text());
					//console.log(select_text);
					if(select_text!=''){
						if(select_text.indexOf(' ')==-1){//单个单词用金山词霸翻译
							var details = {
								url: 'http://open.iciba.com/huaci/dict.php?word='+select_text,
								method: 'GET',
								async: true,
								contentType: 'text'
							};
							kango.xhr.send(details, function(data) {
								if (data.status == 200 && data.response != null) {
									var result_html = (data.response).replace(/(^[\s\S]+?dict\.innerHTML=\'\s*)|(\';[\s\S]+?var\s+loading=)[\s\S]+$/g,'').replace(/\\"/g,'"');
									if(translation_main.length==0){
										var translation_main_html = '<div id="'+PluginConf.css_refix+'translation_main">'+
																		'<div id="'+PluginConf.css_refix+'translation_bar"><i></i><a title="关闭窗口"></a><h2>划词翻译</h2></div>'+
																		'<div id="'+PluginConf.css_refix+'translation_content">'+result_html+'</div>'+
																	'</div>';
										translation_main = $(translation_main_html);
										//translation_main.find('#icIBahyI-title').show();
										translation_main.find('.icIBahyI-new_word').hide();
										_this.set_translation_pos(translation_main,mouse_x,mouse_y);
										translation_main.mouseup(function(event){
											clearTimeout(translation_timer);
											event.stopPropagation();
										});
										$('body').append(translation_main);
									}else{
										translation_main.find('#'+PluginConf.css_refix+'translation_content').html(result_html);
										_this.set_translation_pos(translation_main,mouse_x,mouse_y);
										translation_main.show();
									}
								}else { // something went wrong
									
								}
							});
						}else{//词语或句子用百度翻译
							var details = {
									url: 'http://fanyi.baidu.com/v2transapi',
									method: 'POST',
									async: true,
									params: {'from':'','to':'','query':select_text,'transtype':'trans'},
									contentType: 'json'
							};
							kango.xhr.send(details, function(data) {
									if (data.status == 200 && data.response != null) {
										var result_obj = data.response;
										var result_data = result_obj.trans_result.data;
										var translation_result = result_data[0].dst;
										var result_html = '<div>'+translation_result+'</div><div class="icIBahyI-footer"><a target="_blank" href="http://fanyi.baidu.com/translate#auto/zh/'+encodeURI(select_text)+'">以上为百度翻译结果</a></div>';
										if(translation_main.length==0){
											var translation_main_html = '<div id="'+PluginConf.css_refix+'translation_main">'+
																			'<div id="'+PluginConf.css_refix+'translation_bar"><i></i><a title="关闭窗口"></a><h2>划词翻译</h2></div>'+
																			'<div id="'+PluginConf.css_refix+'translation_content">'+result_html+'</div>'+
																		'</div>';
											translation_main = $(translation_main_html);
											_this.set_translation_pos(translation_main,mouse_x,mouse_y);
											translation_main.mouseup(function(event){
												clearTimeout(translation_timer);
												event.stopPropagation();
											});
											$('body').append(translation_main);
										}else{
											translation_main.find('#'+PluginConf.css_refix+'translation_content').html(result_html);
											_this.set_translation_pos(translation_main,mouse_x,mouse_y);
											translation_main.show();
										}
									}else { // something went wrong
										
									}
							});
						}
					}else{
						translation_timer = setTimeout(function(){
							 translation_main.hide();
						},100);
					}
				},100);
			}
		});
		//关闭翻译窗口
		$('#'+PluginConf.css_refix+'translation_bar a').live('click',function(){
			var translation_main = $('#'+PluginConf.css_refix+'translation_main');
			if(translation_main.length>0){
				translation_main.hide();
			}
		});
	}
	
	//获取选取的文字内容
	this.get_select_text = function(){
		if(window.getSelection){//现代浏览器
			return window.getSelection();
		}else{//IE浏览器
			return document.selection.createRange().text;
		}
	}
	
	//设置翻译窗口的位置
	this.set_translation_pos = function(window_obj,mouse_x,mouse_y){
		//获取文档的大小
		var cw = $(document).width();
		var ch = $(document).height();
		//获取翻译窗口的大小
		var w = window_obj.outerWidth();
		var h = window_obj.outerHeight();
		//窗口位置与鼠标点击位置的偏移
		var offset_x = 10;
		var offset_y = 10;
		if(mouse_x+offset_x+w>cw){
			var left = mouse_x-(offset_x+w);
		}else{
			var left = mouse_x+offset_x;
		}
		if(mouse_y+offset_y+h>ch){
			var top = mouse_y-(offset_y+h);
		}else{
			var top =  mouse_y+offset_y;
		}
		window_obj.css({'left':left+'px','top':top+'px'});
	}
	
	//不同网页的初始化方法
	this.content_init = function(){}
	
	//刷新全部内容
	this.refresh_content = function(){
		_this.refresh_exchange_rate();
		_this.refresh_prodQty();
		_this.refresh_price();
		_this.refresh_weight();
		_this.refresh_actual_tariff();
		_this.refresh_default_tariff();
		_this.refresh_fee();
		_this.refresh_totle_price();
	}
	
	//绑定事件
	this.bind_event = function(){
		//插件窗口取消划词翻译
		$('#'+PluginConf.css_refix+'plugin_main').mouseup(function(event){
			$('#'+PluginConf.css_refix+'translation_bar a').click();
			event.stopPropagation();
		});
		//切换选项卡
		$('#'+PluginConf.css_refix+'top_bar_ul .'+PluginConf.css_refix+'top_bar_li').click(function(){
			var show_id = $(this).attr('show_id');
			$('#'+PluginConf.css_refix+'top_bar_ul .'+PluginConf.css_refix+'top_bar_li').removeClass(PluginConf.css_refix+'selected_li');
			$(this).addClass(PluginConf.css_refix+'selected_li');
			$('#'+PluginConf.css_refix+'plugin_main .'+PluginConf.css_refix+'tab_content').hide();
			$('#'+show_id).show();
		});
		//绑定手机号
		$('#'+PluginConf.css_refix+'bind_mobile').live('click',function(){
			$(this).hide();
			$('#'+PluginConf.css_refix+'bind_result').hide();
			$('#'+PluginConf.css_refix+'bind_show').show();
		});
		$('#'+PluginConf.css_refix+'bind_ok').live('click',function(){
			var mobile_text = $('#'+PluginConf.css_refix+'mobile_text');
			var mobile_num = $.trim(mobile_text.val());
			if(!/^\d{11}$/.test(mobile_num)){
				alert('手机号码格式不正确！');
				mobile_text.focus();
				return;
			}
			//提交手机号码的处理
			var details = {
				url: PluginConf.get_interface_file('bind_user_mobile'),
				method: 'POST',
				async: true,
				params: {'user_id':_this.user_id,'user_mobile':mobile_num},
				contentType: 'json'
			};
			kango.xhr.send(details, function(data) {
				if (data.status == 200 && data.response != null) {
					var result_obj = data.response;
					var status = result_obj.status;
					if(status==1){
						_this.user_mobile = mobile_num;
						$('#'+PluginConf.css_refix+'bind_show').hide();
						$('#'+PluginConf.css_refix+'bind_mobile').text('重新绑定').show();
						$('#'+PluginConf.css_refix+'bind_result').show().find('font').text(mobile_num);
					}else{
						alert(result_obj.message);
					}
				}else { // something went wrong
					
				}
			});
		});
		$('#'+PluginConf.css_refix+'bind_cancle').live('click',function(){
			$('#'+PluginConf.css_refix+'bind_show').hide();
			if(_this.user_mobile!=''){
				$('#'+PluginConf.css_refix+'bind_result').show();
			}
			$('#'+PluginConf.css_refix+'bind_mobile').show();
		});
		//添加收藏
		$('#'+PluginConf.css_refix+'add_fav').click(function(){
			var fav_a = $(this);
			var goods_name = _this.get_name();
			var goods_img = _this.get_img();
			var goods_url = location.href;
			var details = {
				url: PluginConf.get_interface_file('add_favorite_goods'),
				method: 'POST',
				async: true,
				params: {'user_id':_this.user_id,'site_id':_this.site_id,'goods_url':goods_url,'goods_img':goods_img,'goods_name':goods_name,'goods_price':_this.goodsPrice},
				contentType: 'json'
			};
			kango.xhr.send(details, function(data) {
				if (data.status == 200 && data.response != null) {
					var result_obj = data.response;
					var status = result_obj.status;
					if(status==1){
						fav_a.addClass(PluginConf.css_refix+'added_fav').html('<i></i>已关注').unbind('click');
					}else{
						alert(result_obj.message);
					}
				}else { // something went wrong
					
				}
			});
		});
		//减少商品数量
		$('#'+PluginConf.css_refix+'prodQty_reduce').click(function(){
			if(_this.prodQty>1){
				_this.prodQty -= 1;
				_this.refresh_content();
				_this.refresh_actual_tariff();
				_this.refresh_default_tariff();
			}
		});
		//增加商品数量
		$('#'+PluginConf.css_refix+'prodQty_add').click(function(){
			_this.prodQty += 1;
			_this.refresh_content();
			_this.refresh_actual_tariff();
			_this.refresh_default_tariff();
		});
		//切换关税类型
		$('#'+PluginConf.css_refix+'tax_type input').change(function(){
			if($(this).val()=='actual'){
				$('#'+PluginConf.css_refix+'actual_tariff_main').show();
				$('#'+PluginConf.css_refix+'default_tariff_main').hide();
			}else{
				$('#'+PluginConf.css_refix+'actual_tariff_main').hide();
				$('#'+PluginConf.css_refix+'default_tariff_main').show();
			}
			_this.refresh_totle_price();
		});
		//一键提交转运的处理
		$('#'+PluginConf.css_refix+'plugin_submit').click(function(){
			if(_this.tax_rate==0){
				alert('请选择报关种类！');
				return false;
			}
			var window_back = $('#'+PluginConf.css_refix+'window_back');
			if(window_back.length==0){
				window_back = $(PluginBack).appendTo($('body'));
			}else{
				window_back.show();
			}
			window_back.width($(document).width());
			window_back.height($(document).height());
			
			var window_main = $('#'+PluginConf.css_refix+'window_main');
			if(window_main.length==0){
				window_main = $(PluginWindow).appendTo($('body'));
				//获取用户收货地址
				var details = {
					url: PluginConf.get_interface_file('get_user_address',{'user_id':_this.user_id}),
					method: 'GET',
					async: true,
					contentType: 'json'
				};
				kango.xhr.send(details, function(data) {
					if (data.status == 200 && data.response != null) {
						var user_address_obj = data.response;
						var user_province = 0;
						var user_city = 0;
						var user_district = 0;
						if(user_address_obj.status==1){
							var address_arr = user_address_obj.attach;
							if(address_arr.user_province){
								user_province = address_arr.user_province;
							}
							if(address_arr.user_city){
								user_city = address_arr.user_city;
							}
							if(address_arr.user_district){
								user_district = address_arr.user_district;
							}
							if(address_arr.user_name){
								$('#'+PluginConf.css_refix+'receive_name').val(address_arr.user_name);
							}
							if(address_arr.user_mobile){
								$('#'+PluginConf.css_refix+'receive_mobile').val(address_arr.user_mobile);
							}else if(_this.user_mobile){
								$('#'+PluginConf.css_refix+'receive_mobile').val(_this.user_mobile);
							}
							if(address_arr.user_address){
								$('#'+PluginConf.css_refix+'receive_address').val(address_arr.user_address);
							}
						}else{
							if(_this.user_mobile){
								$('#'+PluginConf.css_refix+'receive_mobile').val(_this.user_mobile);
							}
						}
						//加载地区选择控件
						var area_obj = load_area_widget(PluginConf.css_refix+'area',{
							'province_id':user_province,
							'city_id':user_city,
							'district_id':user_district
						});
					}
				});
				//获取转运地址列表
				var details = {
					url: PluginConf.get_interface_file('get_transport_address_list'),
					method: 'GET',
					async: true,
					contentType: 'json'
				};
				kango.xhr.send(details, function(data) {
					if (data.status == 200 && data.response != null) {
						var transport_address_obj = data.response;
						if(transport_address_obj.status==1){
							var address_arr = transport_address_obj.attach;
							var transport_address_option = '';
							for(var i=0,len=address_arr.length;i<len;i++){
								transport_address_option += '<option value="'+address_arr[i].address_id+'">'+address_arr[i].address_name+'</option>';
							}
						}else{
							var transport_address_option = '<option value="0">转运地址列表为空</option>';
						}
						$('#'+PluginConf.css_refix+'transport_address').empty().append(transport_address_option);
					}else { // something went wrong
						
					}
				});
				//加载新浪微博分享插件
				var sina_weibo_share = $('<a id="'+PluginConf.css_refix+'sina_weibo_share" title="新浪微博分享" href="javascript:;"><img src="'+PluginConf.img_path+'sina_favicon.ico" width="16px" height="16px" border="0">分享到新浪微博</a>').insertAfter($('#'+PluginConf.css_refix+'transport_submit')).click(function(){
					var share_title = '用#海淘100#插件提交转运，分享新浪微博享折扣！';
					window.top.open('http://v.t.sina.com.cn/share/share.php?title='+encodeURIComponent(share_title)+'&url='+encodeURIComponent(location.href)+'&source=bookmark&pic='+_this.get_img(),'_blank','width=450,height=400');
				});
				//绑定事件
				window_main.mouseup(function(event){
					$('#'+PluginConf.css_refix+'translation_bar a').click();
					event.stopPropagation();
				});
				$('#'+PluginConf.css_refix+'tax_include').change(function(){
					var declared_value_obj = $('#'+PluginConf.css_refix+'declared_value');
					var declared_value = parseFloat(declared_value_obj.val());
					if($(this).is(':checked')){
						declared_value += _this.tax_price;
					}else{
						declared_value -= _this.tax_price;
					}
					declared_value_obj.val(declared_value.toFixed(2));
				});
				$('#'+PluginConf.css_refix+'declared_value').blur(function(){
					var declared_value = parseFloat($(this).val());
					if(!/^\d+(\.\d+)?$/.test(declared_value)){
						alert('价格格式不正确！');
						if($('#'+PluginConf.css_refix+'tax_include').is(':checked')){
							var tax_price = _this.tax_price;
						}else{
							var tax_price = 0;
						}
						var unit_price = _this.goodsPrice + tax_price;
						$(this).val(unit_price);
					}else{
						if($('#'+PluginConf.css_refix+'tax_include').is(':checked')){
							if(declared_value<_this.tax_price){
								$(this).val(_this.tax_price);
							}
						}
					}
				});
				$('#'+PluginConf.css_refix+'declared_num').blur(function(){
					var declared_num = $.trim($(this).val());
					if(!/^\d+(\.\d+)?$/.test(declared_num)||declared_num==0){
						$(this).val(_this.prodQty);
						var kgWeight = Math.round(_this.prodWeight*_this.prodQty*PluginConf.lb_rate*100)/100;
					}else{
						var kgWeight = Math.round(_this.prodWeight*declared_num*PluginConf.lb_rate*100)/100;
					}
					$('#'+PluginConf.css_refix+'goods_kg').text(kgWeight);
				});
			}else{
				window_main.show();
			}
			$('#'+PluginConf.css_refix+'tax_include').attr('checked',false);
			//窗口居中
			var sw = $(window).width();
			var sh = $(window).height();
			var w = window_main.outerWidth();
			var h = window_main.outerHeight();
			var scroll_left = $(document).scrollLeft();
			var scroll_top = $(document).scrollTop();
			var w_left = scroll_left + Math.round((sw-w)/2);
			var w_top = scroll_top + Math.round((sh-h)/2);
			window_main.css({'left':w_left+'px','top':w_top+'px'});
			//加载数据
			var cat_option = $('#'+PluginConf.css_refix+'product_cat option:selected');
			var goods_cat_str = '';
			cat_option.each(function(){
				goods_cat_str += $(this).text()+'>>';
			});
			goods_cat_str = goods_cat_str.replace(/>>$/,'');
			$('#'+PluginConf.css_refix+'goods_cat').text(goods_cat_str);
			
			$('#'+PluginConf.css_refix+'declared_value').val(_this.goodsPrice);
			
			$('#'+PluginConf.css_refix+'declared_num').val(_this.prodQty);
			
			var kgWeight = Math.round(_this.prodWeight*_this.prodQty*PluginConf.lb_rate*100)/100;
			$('#'+PluginConf.css_refix+'goods_kg').text(kgWeight);
		});
		//关闭转运窗口
		$('#'+PluginConf.css_refix+'window_close').live('click',function(){
			$('#'+PluginConf.css_refix+'window_back').hide();
			$('#'+PluginConf.css_refix+'window_main').hide();
		});
		//提交转运数据
		$('#'+PluginConf.css_refix+'transport_form').live('submit',function(){
			//防止重复提交
			if(_this.animating){
				return false;
			}
			
			//获取要提交的数据
			var goods_url = location.href;
			var goods_name = _this.get_name();
			var goods_img = _this.get_img();
			var tax_include = ($('#'+PluginConf.css_refix+'tax_include').is(':checked'))?1:0;
			var goods_price = parseFloat($('#'+PluginConf.css_refix+'declared_value').val());
			if(tax_include==1){
				goods_price = (goods_price-_this.tax_price).toFixed(2);
			}
			var goods_num = parseInt($('#'+PluginConf.css_refix+'declared_num').val());
			var zh_goods_name_obj = $('#'+PluginConf.css_refix+'zh_goods_name');
			var zh_goods_name = $.trim(zh_goods_name_obj.val());
			var receive_name_obj = $('#'+PluginConf.css_refix+'receive_name');
			var receive_name = $.trim(receive_name_obj.val());
			if(receive_name==''){
				alert('请输入收件人姓名！');
				receive_name_obj.focus();
				return false;
			}
			var receive_mobile_obj = $('#'+PluginConf.css_refix+'receive_mobile');
			var receive_mobile = $.trim(receive_mobile_obj.val());
			if(receive_mobile==''){
				alert('请输入手机号码！');
				receive_mobile_obj.focus();
				return false;
			}
			if(!/^\d{11}$/.test(receive_mobile)){
				alert('手机号码格式不正确！');
				receive_mobile_obj.focus();
				return false;
			}
			var receive_province_obj = $('#'+PluginConf.css_refix+'province_id');
			var receive_province = parseInt(receive_province_obj.val());
			if(receive_province==0){
				alert('请选择省份！');
				return false;
			}
			var receive_city_obj = $('#'+PluginConf.css_refix+'city_id');
			var receive_city = parseInt(receive_city_obj.val());
			if(receive_city==0){
				alert('请选择城市！');
				return false;
			}
			var receive_district_obj = $('#'+PluginConf.css_refix+'district_id');
			var receive_district = parseInt(receive_district_obj.val());
			if(receive_district==0){
				alert('请选择区县！');
				return false;
			}
			var receive_address_obj = $('#'+PluginConf.css_refix+'receive_address');
			var receive_address = $.trim(receive_address_obj.val());
			if(receive_address==''){
				alert('请输入详细街道地址！');
				receive_address_obj.focus();
				return false;
			}
			var attach_service_obj = $('#'+PluginConf.css_refix+'attach_service input:checkbox');
			var attach_service1 = $(attach_service_obj[0]).is(':checked')?1:0;
			var attach_service2 = $(attach_service_obj[1]).is(':checked')?1:0;
			var attach_service3 = $(attach_service_obj[2]).is(':checked')?1:0;
			var taddress_id = $('#'+PluginConf.css_refix+'transport_address').val();
			var order_remarks = $('#'+PluginConf.css_refix+'order_remarks').val();
			
			//提交订单
			var details = {
				url: PluginConf.get_interface_file('transport_submit'),
				method: 'POST',
				async: true,
				params: {'user_id':_this.user_id,'site_id':_this.site_id,'goods_url':goods_url,'goods_img':goods_img,'goods_name':goods_name,'goods_price':goods_price,'goods_num':goods_num,'zh_goods_name':zh_goods_name,
				'tax_price':_this.tax_price,'tax_include':tax_include,'receive_name':receive_name,'receive_mobile':receive_mobile,'receive_province':receive_province,'receive_city':receive_city,'receive_district':receive_district,
				'receive_address':receive_address,'taddress_id':taddress_id,'attach_service1':attach_service1,'attach_service2':attach_service2,'attach_service3':attach_service3,'order_remarks':order_remarks},
				contentType: 'json'
			};
			kango.xhr.send(details, function(data) {
				if (data.status == 200 && data.response != null) {
					var result_obj = data.response;
					var status = result_obj.status;
					if(status==1){
						var order_id = result_obj.attach.order_id;//获取提交之后的订单id
						$('#'+PluginConf.css_refix+'transport_form')[0].reset();//重置表单
						$('#'+PluginConf.css_refix+'window_main').hide();
						var window_success_main = $('#'+PluginConf.css_refix+'window_success_main');
						if(window_success_main.length==0){
							window_success_main = $(PluginSuccess).appendTo($('body'));
						}else{
							window_success_main.show();
						}
						//加载新浪微博分享插件
						$('#'+PluginConf.css_refix+'window_success_share').empty().append('分享到新浪微博，立享折扣！<a href="javascript:;"><img src="'+PluginConf.img_path+'sina_favicon.ico" width="16px" height="16px" border="0"/></a>').find('a').click(function(){
							var share_title = '我在'+_this.site_name+'用#海淘100#插件购买了【'+_this.get_name()+'】，获得了2元折扣。@小伙伴1@小伙伴2,@小伙伴3';
							window.top.open('http://v.t.sina.com.cn/share/share.php?title='+encodeURIComponent(share_title)+'&url='+encodeURIComponent(location.href)+'&source=bookmark&pic='+_this.get_img()+'&order_id='+order_id,'_blank','width=450,height=400');
						});
						//窗口居中
						var sw = $(window).width();
						var sh = $(window).height();
						var w = window_success_main.outerWidth();
						var h = window_success_main.outerHeight();
						var scroll_left = $(document).scrollLeft();
						var scroll_top = $(document).scrollTop();
						var w_left = scroll_left + Math.round((sw-w)/2);
						var w_top = scroll_top + Math.round((sh-h)/2);
						window_success_main.css({'left':w_left+'px','top':w_top+'px'});
						//绑定事件
						$('#'+PluginConf.css_refix+'window_success_ok').unbind('click').click(function(){
							var submit_x = $(this).offset().left;
							var submit_y = $(this).offset().top;
							var submit_w = $(this).outerWidth();
							var submit_h = $(this).outerHeight();
							var plugin_container = $('#'+PluginConf.css_refix+'plugin_container');
							if(plugin_container.length>0){
								var end_obj = plugin_container;
							}else{
								var end_obj = $('#'+PluginConf.css_refix+'cart_count');
							}
							var end_x = end_obj.offset().left;
							var end_y = end_obj.offset().top;
							var end_w = end_obj.outerWidth();
							var end_h = end_obj.outerHeight();
							//关闭窗口
							$('#'+PluginConf.css_refix+'window_back').hide();
							$('#'+PluginConf.css_refix+'window_success_main').hide();
							//开始动画效果
							_this.animating = true;
							$('<img id="'+PluginConf.css_refix+'animate_cart" src="'+PluginConf.img_path+'cart_ico.png"/>')
							.css({'width':'40px','height':'40px','opacity':1,'left':(submit_x+submit_w/2-20)+'px','top':(submit_y+submit_h/2-20)+'px'}).appendTo($('body'))
							.animate({'width':'12px','height':'12px','opacity':0.5,'left':(end_x+end_w/2-20)+'px','top':(end_y+end_h/2-20)+'px'},1000,function(){
								$(this).remove();
								_this.animating = false;
								//刷新运单列表
								_this.cart_page = 1;
								_this.refresh_cart_list();
								//运单个数闪烁
								var light_count = 0;
								var light_class = PluginConf.css_refix+'light_class';
								var cart_count = $('#'+PluginConf.css_refix+'cart_count');
								var light_timer = setInterval(function(){
									if(cart_count.hasClass(light_class)){
										cart_count.removeClass(light_class);
										light_count += 1;
										if(light_count==5){
											clearInterval(light_timer);
										}
									}else{
										cart_count.addClass(light_class);
									}
								},300);
							});
						});
					}else{
						alert(result_obj.message);
					}
				}else { // something went wrong
					
				}
			});
			return false;
		});
		//购物车全选反选
		$('#'+PluginConf.css_refix+'check_all').click(function(){
			$('#'+PluginConf.css_refix+'cart_main .'+PluginConf.css_refix+'cart_goods_check').attr('checked',$(this).is(':checked'));
			_this.refresh_cart_checked_num();
		});
		$('#'+PluginConf.css_refix+'cart_main .'+PluginConf.css_refix+'cart_goods_check').live('click',function(){
			_this.refresh_cart_checked_num();
		});
		//提交运单号
		$('#'+PluginConf.css_refix+'cart_table .'+PluginConf.css_refix+'shipping_num_submit a').live('click',function(){
			var this_obj = $(this);
			var shipping_num_obj = $(this).parent().siblings('.'+PluginConf.css_refix+'shipping_num_text').find('input');
			var shipping_num = $.trim(shipping_num_obj.val());
			var order_id_obj = $(this).parents('tr');
			var order_id = order_id_obj.attr('order_id');
			if(shipping_num!=''){
				var details = {
					url: PluginConf.get_interface_file('update_shipping_num'),
					method: 'POST',
					async: true,
					params: {'order_id':order_id,'shipping_num':shipping_num},
					contentType: 'json'
				};
				kango.xhr.send(details, function(data) {
					if (data.status == 200 && data.response != null) {
						var result_obj = data.response;
						var status = result_obj.status;
						if(status==1){
							this_obj.parents('.'+PluginConf.css_refix+'shipping_num_main').hide();
						}else{
							alert(result_obj.message);
						}
					}else { // something went wrong
						
					}
				});
			}
		});
		//删除购物车商品
		$('#'+PluginConf.css_refix+'cart_table .'+PluginConf.css_refix+'cart_goods_delete').live('click',function(){
			if(confirm('确定要删除这个商品吗？')){
				var parent_tr = $(this).parents('tr');
				var order_id = parent_tr.attr('order_id');
				var details = {
					url: PluginConf.get_interface_file('transport_order_delete'),
					method: 'POST',
					async: true,
					params: {'order_id':order_id,},
					contentType: 'json'
				};
				kango.xhr.send(details, function(data) {
					if (data.status == 200 && data.response != null) {
						var result_obj = data.response;
						var status = result_obj.status;
						if(status==1){
							var cart_count = parseInt($('#'+PluginConf.css_refix+'cart_count').text());
							$('#'+PluginConf.css_refix+'cart_count').text(cart_count-1);
							_this.cart_page = 1;
							_this.refresh_cart_list();
						}else{
							alert(result_obj.message);
						}
					}else { // something went wrong
						
					}
				});
			}
		});
	}
	
	//记录用户浏览记录
	this.record_view_history = function(){
		if(_this.goodsPrice>0){
			setTimeout(function(){
				var goods_name = _this.get_name();
				var goods_img = _this.get_img();
				var goods_url = location.href;
				var details = {
					url: PluginConf.get_interface_file('record_view_history'),
					method: 'POST',
					async: true,
					params: {'user_id':_this.user_id,'site_id':_this.site_id,'goods_url':goods_url,'goods_img':goods_img,'goods_name':goods_name,'goods_price':_this.goodsPrice},
					contentType: 'text'
				};
				kango.xhr.send(details, function(data) {
					if (data.status == 200 && data.response != null) {
						
					}else { // something went wrong
						
					}
				});
			},5000);
		}
	};
	
	//截取字符串
	this.sub_str = function(str,length){
		var str_length = str.length;
		if(str_length>length){
			return str.substr(0,length)+'..';
		}else{
			return str;
		}
	}
	
	//获取时间字符串中的日期
	this.get_date = function(time_str){
		var time_arr = time_str.split(' ');
		return time_arr[0];
	}
	
	//刷新汇率
	this.refresh_exchange_rate = function(){
		$("#"+PluginConf.css_refix+"exchange_rate").text(parseFloat(_this.exchange_rate).toFixed(2));
	}
	
	//获取商品价格
	this.get_price = function(){}
	
	//刷新商品价格
	this.refresh_price = function(){
		if(!_this.price_loaded){
			var prodPrice = _this.get_price();
			_this.goodsPrice = parseFloat(parseFloat(prodPrice).toFixed(2));
			_this.price_loaded = true;
		}
		var totle_price = (_this.goodsPrice*_this.prodQty).toFixed(2);
		$("#"+PluginConf.css_refix+"goods_price").text('￥'+ totle_price);
	}
	
	//获取商品重量
	this.get_weight = function(){}
	
	//刷新商品重量
	this.refresh_weight = function(){
		if(!_this.weight_loaded){
			var prodWeight = _this.get_weight();
			_this.prodWeight = parseFloat(parseFloat(prodWeight).toFixed(2));
			_this.weight_loaded = true;
		}
		var totle_weight = (_this.prodWeight*_this.prodQty).toFixed(2);
		if(_this.prodWeight<=0.01){
			$("#"+PluginConf.css_refix+"weight_value").hide();
			$("#"+PluginConf.css_refix+"weight_input").val(totle_weight).show().unbind('blur').blur(function(){
				_this.prodWeight = parseFloat(($(this).val()/_this.prodQty).toFixed(2));
				_this.refresh_content();
				_this.refresh_actual_tariff();
				_this.refresh_default_tariff();
			});
		}else{
			$("#"+PluginConf.css_refix+"weight_value").text(totle_weight).siblings('.'+PluginConf.css_refix+'plugin_list_tip').hide();
			$("#"+PluginConf.css_refix+"weight_input").val(totle_weight);
		}
	}
	
	//刷新商品数量
	this.refresh_prodQty = function(){
		$("#"+PluginConf.css_refix+"prodQty").text(_this.prodQty);
	}
	
	//获取用户登录状态
	this.get_user_login = function(){
		var details = {
			url: PluginConf.get_interface_file('get_user_info',{'user_id':_this.user_id}),
			method: 'GET',
			async: true,
			contentType: 'json'
		};
		kango.xhr.send(details, function(data) {
			if (data.status == 200 && data.response != null) {
				var result_obj = data.response;
				var status = result_obj.status;
				if(status==1){
					var message = result_obj.message;
					var attach = result_obj.attach;
					_this.user_mobile = attach.user_mobile;
					
					var user_login_html = '<span id="'+PluginConf.css_refix+'bind_result">欢迎回来，<font>'+_this.user_mobile+'</font></span>';
					user_login_html += '<a id="'+PluginConf.css_refix+'bind_mobile" href="javascript:;">绑定手机号码</a>';
					user_login_html += '<span id="'+PluginConf.css_refix+'bind_show">'+
											'<input type="text" id="'+PluginConf.css_refix+'mobile_text" class="'+PluginConf.css_refix+'plugin_text" maxlength="11" value="'+_this.user_mobile+'"/>'+
											'<a id="'+PluginConf.css_refix+'bind_ok" class="'+PluginConf.css_refix+'bind_button">确定</a>'+
											'<a id="'+PluginConf.css_refix+'bind_cancle" class="'+PluginConf.css_refix+'bind_button">取消</a>'+
										'</span>';
					$('#'+PluginConf.css_refix+'user_about').append(user_login_html);
					if(_this.user_mobile==''){
						$('#'+PluginConf.css_refix+'bind_result').hide();
					}else{
						$('#'+PluginConf.css_refix+'bind_mobile').text('重新绑定');
					}
				}else{
					alert(result_obj.message);
				}
			}else { // something went wrong
				
			}
		});
	}
	
	//加载产品分类
	this.load_product_cat = function(){
		var cat_obj = productCat(PluginConf.css_refix+'product_cat');
		cat_obj.change(function(){
			var last_select = $(this).find('select:last');
			if(last_select.val()==-1){
				_this.tax_type = 0;
				_this.dutiable_value = 0;
				_this.tax_rate = 0;
			}else{
				var selected_option = last_select.find('option:selected');
				_this.tax_type = parseInt(selected_option.attr('tax_type'));
				_this.dutiable_value = Math.round(selected_option.attr('dutiable_value'));
				_this.tax_rate = parseInt(selected_option.attr('tax_rate'));
			}
			_this.refresh_tax_rate();
			_this.refresh_actual_tariff();
			_this.refresh_default_tariff();
			_this.refresh_totle_price();
		});
	}
	
	//刷新直邮中国标记
	this.refresh_china_tag = function(){
		if(_this.direct_mail_china){
			$('#'+PluginConf.css_refix+'direct_mail_china').show();
		}
	}
	
	//刷新用户运单
	this.refresh_cart_list = function(){
		kango.invokeAsync('kango.storage.getItem', 'user_id', function(data) {
			var user_id = data;
			var details = {
				url: PluginConf.get_interface_file('get_transport_order',{'user_id':user_id,'page':_this.cart_page}),
				method: 'GET',
				async: true,
				contentType: 'json'
			};
			kango.xhr.send(details, function(data) {
				if (data.status == 200 && data.response != null) {
					var result_obj = data.response;
					var status = result_obj.status;
					if(status==1){
						var message = result_obj.message;
						var attach = result_obj.attach;
						var order_list = attach.order_list;
						var cart_html = '';
						var cart_length = order_list.length;
						for(var i=0;i<cart_length;i++){
							var cart_list = order_list[i];
							var status_id = cart_list.status_id;
							if(status_id==1){
								var opera_html = '<div class="'+PluginConf.css_refix+'shipping_num_div">'+
													'<span class="'+PluginConf.css_refix+'add_shipping_num">运单号<i></i></span>'+
													'<div class="'+PluginConf.css_refix+'shipping_num_main">'+
														'<div class="'+PluginConf.css_refix+'shipping_num_content">'+
															'<i class="'+PluginConf.css_refix+'top_border_ico"></i>'+
															'<div class="'+PluginConf.css_refix+'shipping_num_text"><input type="text" class="'+PluginConf.css_refix+'plugin_text" value="'+cart_list.shipping_num+'"></div>'+
															'<div class="'+PluginConf.css_refix+'shipping_num_submit"><a>提交</a></div>'+
														'</div>'+
													'</div>'+
												'</div>'+
												'<p><a class="'+PluginConf.css_refix+'cart_goods_delete">删除订单</a></p>';
							}else if(status_id==2){
								var opera_html = '<p><a class="'+PluginConf.css_refix+'order_pay" href="'+PluginConf.source_url+'action.php?act=alipay_request&order_id='+cart_list['order_id']+'" target="_blank">去付款</a></p><p><a class="'+PluginConf.css_refix+'cart_goods_delete">删除订单</a></p>';
							}else if(status_id==3){
								var opera_html = '<p><a>申请退款</a></p>';
							}else{
								var opera_html = '';
							}
							cart_html += '<tr class="'+PluginConf.css_refix+'cart_list" order_id="'+cart_list['order_id']+'">'+
											'<td style="text-align:left;"><input type="checkbox" class="'+PluginConf.css_refix+'cart_goods_check" name="'+PluginConf.css_refix+'cart_goods_check"/></td>'+
											'<td align="center"><a href="'+cart_list['goods_url']+'" target="_blank" class="'+PluginConf.css_refix+'cart_goods_img"><img src="'+cart_list['goods_img']+'"/></a></td>'+
											'<td align="center"><a class="'+PluginConf.css_refix+'cart_goods_name" href="'+cart_list['goods_url']+'" target="_blank" title="'+cart_list['goods_name']+'">'+_this.sub_str(cart_list['goods_name'],20)+'</a></td>'+
											'<td align="center"><span class="'+PluginConf.css_refix+'cart_goods_num">'+cart_list['goods_num']+'</span></td>'+
											'<td align="center"><span class="'+PluginConf.css_refix+'cart_goods_time" title="'+cart_list['add_time']+'">'+_this.get_date(cart_list['add_time'])+'</span></td>'+
											'<td align="center"><span class="'+PluginConf.css_refix+'cart_goods_state">'+cart_list['status_name']+'</span></td>'+
											'<td align="center">'+opera_html+'</td>'+
										'</tr>';
						}
						$("#"+PluginConf.css_refix+"cart_count").text(attach.record_count);
						$('#'+PluginConf.css_refix+'cart_table .'+PluginConf.css_refix+'cart_list').remove();
						$(cart_html).insertBefore($("#"+PluginConf.css_refix+"cart_check")).find('.'+PluginConf.css_refix+'shipping_num_div').hover(function(){
							$(this).find('.'+PluginConf.css_refix+'shipping_num_main').show();
						},function(){
							$(this).find('.'+PluginConf.css_refix+'shipping_num_main').hide();
						});
						//加载分页html
						var page_html = attach.page_html;
						page_html = page_html.replace(/(id|class)="([^"]+)"/g,"$1"+'="'+PluginConf.css_refix+"$2"+'"');
						var page_obj = $(page_html);
						page_obj.find('a').click(function(){
							_this.cart_page = $(this).attr('page');
							_this.refresh_cart_list();
							return false;
						});
						$('#'+PluginConf.css_refix+'cart_page').empty().append(page_obj);
					}else{
						alert(result_obj.message);
					}
				}else { // something went wrong
					
				}
			});
		});
	}
	
	//刷新税率
	this.refresh_tax_rate = function(){
		if(_this.tax_rate==0){
			$('#'+PluginConf.css_refix+'tax_rate').text('--');
		}else{
			$('#'+PluginConf.css_refix+'tax_rate').text(_this.tax_rate+'%');
		}
	}
	
	//刷新关税（实报）
	this.refresh_actual_tariff = function(){
		if(_this.tax_rate==0){
			_this.actual_tariff = 0;
			$('#'+PluginConf.css_refix+'actual_tariff').text('--');
		}else{
			_this.actual_tariff = parseFloat((_this.tax_rate*0.01*_this.goodsPrice).toFixed(2));
			var totle_actual_tariff = (_this.actual_tariff*_this.prodQty).toFixed(2);
			$('#'+PluginConf.css_refix+'actual_tariff').text('￥'+totle_actual_tariff);
		}
	}
	
	//刷新关税（默认）
	this.refresh_default_tariff = function(){
		if(_this.tax_rate==0||_this.dutiable_value==0){
			_this.default_tariff = 0;
			$('#'+PluginConf.css_refix+'dutiable_value').text('--');
			$('#'+PluginConf.css_refix+'default_tariff').text('--');
		}else{
			if(_this.tax_type==1 || _this.tax_type==3){
				_this.default_tariff = parseFloat((_this.tax_rate*0.01*_this.dutiable_value).toFixed(2));
			}else{
				var kgWeight = Math.ceil(_this.prodWeight*PluginConf.lb_rate*100)/100;
				_this.default_tariff = parseFloat((kgWeight*_this.tax_rate*0.01*_this.dutiable_value).toFixed(2));
			}
			var totle_default_tariff = (_this.default_tariff*_this.prodQty).toFixed(2);
			$('#'+PluginConf.css_refix+'dutiable_value').text(_this.dutiable_value);
			$('#'+PluginConf.css_refix+'default_tariff').text('￥'+totle_default_tariff);
		}
	}
	
	//刷新运费
	this.refresh_fee = function(){
		var kgWeight = Math.ceil(_this.prodWeight*PluginConf.lb_rate*100)/100;
		var fee1 = Math.ceil(_this.prodWeight*PluginConf.firstFee1);
		var fee2 = PluginConf.secondFee1 + (kgWeight>1?Math.ceil(kgWeight-1)*PluginConf.secondFee2:0);
		_this.totleFee = fee1 + fee2;
		var totle_fee1 = fee1*_this.prodQty;
		var totle_fee2 = fee2*_this.prodQty;
		var totle_fee = _this.totleFee*_this.prodQty;
		$('#'+PluginConf.css_refix+'fee1').text(totle_fee1);
		$('#'+PluginConf.css_refix+'fee2').text(totle_fee2);
		$('#'+PluginConf.css_refix+'fee_totle').text(totle_fee);
	}
	
	//刷新总价
	this.refresh_totle_price = function(){
		if(_this.goodsPrice==0||_this.tax_rate==0){
			_this.totlePrice = 0;
			$('#'+PluginConf.css_refix+'totle_price').text('--');
		}else{
			var tax_type_input = $('#'+PluginConf.css_refix+'tax_type input:checked');
			if(tax_type_input.val()=='actual'){
				_this.tax_price = _this.actual_tariff;
			}else{
				_this.tax_price = _this.default_tariff;
			}
			if(_this.tax_price==0){
				_this.totlePrice = 0;
				$('#'+PluginConf.css_refix+'totle_price').text('--');
			}else{
				_this.totlePrice = parseFloat((_this.goodsPrice + _this.tax_price + _this.totleFee)*_this.prodQty).toFixed(2);
				$('#'+PluginConf.css_refix+'totle_price').text('￥'+_this.totlePrice);
			}
		}
	}
	
	//刷新购物车选择的商品数量
	this.refresh_cart_checked_num = function(){
		var checked_num = $('#'+PluginConf.css_refix+'cart_main .'+PluginConf.css_refix+'cart_goods_check:checked').length;
		$('#'+PluginConf.css_refix+'checked_num').text(checked_num);
		if(checked_num>0){
			$('#'+PluginConf.css_refix+'cart_submit').removeClass(PluginConf.css_refix+'disable_button');
		}else{
			$('#'+PluginConf.css_refix+'cart_submit').addClass(PluginConf.css_refix+'disable_button');
		}
	}
}